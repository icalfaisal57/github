name: Run Daily PM2.5 Prediction

on:
  # Jalan otomatis setiap hari jam 00:00 UTC (07:00 WIB)
  schedule:
    - cron: '0 0 * * *'
  
  # Manual run dengan pilihan branch
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run (default: FIX)'
        required: false
        default: 'FIX'
        type: string

permissions:
  contents: read

jobs:
  run-prediction:
    runs-on: ubuntu-latest
    
    steps:
      - name: Determine Branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "branch=FIX" >> $GITHUB_OUTPUT
            echo "üìÖ Scheduled run - using branch: FIX"
          else
            echo "branch=${{ inputs.branch || 'FIX' }}" >> $GITHUB_OUTPUT
            echo "üîß Manual run - using branch: ${{ inputs.branch || 'FIX' }}"
          fi
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.branch.outputs.branch }}
          lfs: true
          fetch-depth: 1
      
      - name: Verify Branch
        run: |
          echo "‚úì Current branch: $(git branch --show-current)"
          echo "‚úì Last commit: $(git log -1 --oneline)"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create Service Account Key File
        env:
          GEE_KEY_JSON: ${{ secrets.GEE_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "üîê Membuat file service_key.json..."
          printf "%s" "$GEE_KEY_JSON" > service_key.json
          
          # Verify file created
          if [ -f service_key.json ]; then
            echo "‚úì File service_key.json berhasil dibuat"
            ls -lh service_key.json
          else
            echo "‚úó GAGAL: File service_key.json tidak ditemukan"
            exit 1
          fi
      
      - name: Set Google Auth Environment Variable
        run: |
          SERVICE_KEY_PATH="${{ github.workspace }}/service_key.json"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$SERVICE_KEY_PATH" >> $GITHUB_ENV
          echo "‚úì GOOGLE_APPLICATION_CREDENTIALS set ke: $SERVICE_KEY_PATH"
      
      - name: Verify Environment
        run: |
          echo "================================================"
          echo "üîç VERIFIKASI ENVIRONMENT"
          echo "================================================"
          echo "Working Directory: $(pwd)"
          echo "Python Version: $(python --version)"
          echo "Pip Version: $(pip --version)"
          echo ""
          echo "Files in workspace:"
          ls -la
          echo ""
          echo "GOOGLE_APPLICATION_CREDENTIALS: $GOOGLE_APPLICATION_CREDENTIALS"
          echo "Service Key File:"
          ls -lh "$GOOGLE_APPLICATION_CREDENTIALS"
          echo ""
          echo "URL_TARGET_API: ${URL_TARGET_API:0:50}..." # Show first 50 chars only
          echo "================================================"
        env:
          URL_TARGET_API: ${{ secrets.URL_TARGET_API }}
      
      - name: Run Python Script
        env:
          URL_TARGET_API: ${{ secrets.URL_TARGET_API }}
        run: |
          echo "================================================"
          echo "üöÄ MENJALANKAN ESTIMASI PM2.5"
          echo "================================================"
          echo "Start Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          python main.py
          
          EXIT_CODE=$?
          echo ""
          echo "================================================"
          echo "End Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Exit Code: $EXIT_CODE"
          echo "================================================"
          
          exit $EXIT_CODE
      
      - name: Upload Logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: error-logs
          path: |
            *.log
            service_key.json
          retention-days: 7
      
      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up sensitive files..."
          rm -f service_key.json
          echo "‚úì Cleanup complete"
