name: Run Daily PM2.5 Prediction

# Pemicu: Jam 7 pagi WIB (00:00 UTC) dan manual
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  run-prediction:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Download kode dan model LFS
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true # Wajib untuk mengambil model .joblib

      # 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Gunakan versi Python yang Anda inginkan
      
      # 3. Install semua library
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # 4. Tulis Kunci Akun Layanan dari Secret ke file
      - name: Create Service Account Key File
        env:
          GEE_KEY_JSON: ${{ secrets.GEE_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "$GEE_KEY_JSON" > service_key.json
          echo "✓ File service_key.json telah dibuat"

      # 5. Atur Environment Variable (CARA OTENTIKASI YANG BENAR)
      - name: Set Google Auth Environment Variable
        run: |
          echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/service_key.json" >> $GITHUB_ENV
          echo "✓ Variabel GOOGLE_APPLICATION_CREDENTIALS telah diatur"

      # 6. Jalankan Skrip Python
      - name: Run Python Script
        env:
          # Berikan skrip akses ke URL API
          URL_TARGET_API: ${{ secrets.URL_TARGET_API }}
        run: python main.py
