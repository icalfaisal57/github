name: Run Daily PM2.5 Prediction

on:
  # Jalan otomatis setiap hari jam 00:00 UTC (07:00 WIB)
  schedule:
    - cron: '0 0 * * *'
  # Bisa dijalankan manual dari tab Actions
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch atau tag yang akan dijalankan'
        required: false
        default: 'fix'

permissions:
  contents: read

jobs:
  run-prediction:
    runs-on: ubuntu-latest

    # Catatan:
    # - Workflow terjadwal SELALU dieksekusi dari default branch,
    #   jadi kita paksa checkout branch 'fix' di langkah checkout.
    # - Untuk manual run, kita ambil input ref (default 'fix').

    steps:
      - name: Checkout repository (branch fix untuk schedule, atau input saat manual)
        uses: actions/checkout@v4
        with:
          lfs: true
          # Jika event adalah schedule, pakai 'fix'.
          # Jika manual, pakai inputs.ref (default 'fix').
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || 'FIX' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create Service Account Key File
        env:
          GEE_KEY_JSON: ${{ secrets.GEE_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "Menulis GEE_KEY_JSON ke service_key.json..."
          printf "%s" "$GEE_KEY_JSON" > service_key.json
          ls -l service_key.json
          echo "✓ File service_key.json telah dibuat."

      - name: Set Google Auth Environment Variable
        run: |
          echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/service_key.json" >> $GITHUB_ENV
          echo "✓ Variabel GOOGLE_APPLICATION_CREDENTIALS telah diatur."

      - name: Run Python Script
        env:
          URL_TARGET_API: ${{ secrets.URL_TARGET_API }}
        run: |
          echo "--- MEMULAI LANGKAH 6 ---"
          echo "GOOGLE_APPLICATION_CREDENTIALS = $GOOGLE_APPLICATION_CREDENTIALS"
          ls -l "$GOOGLE_APPLICATION_CREDENTIALS"
          echo "--- Menjalankan Skrip Python ---"
          python main.py
