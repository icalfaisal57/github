name: Run Daily PM2.5 Prediction

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  run-prediction:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      # 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # 4. Tulis Kunci Akun Layanan dan VERIFIKASI
      - name: Create Service Account Key File
        env:
          GEE_KEY_JSON: ${{ secrets.GEE_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "Menulis GEE_KEY_JSON ke service_key.json..."
          # Menggunakan 'printf' agar lebih aman untuk string JSON
          printf "%s" "$GEE_KEY_JSON" > service_key.json
          
          # VERIFIKASI 1: Cek apakah file ada dan ukurannya tidak nol
          ls -l service_key.json
          echo "✓ File service_key.json telah dibuat."

      # 5. Atur Environment Variable
      - name: Set Google Auth Environment Variable
        run: |
          echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/service_key.json" >> $GITHUB_ENV
          echo "✓ Variabel GOOGLE_APPLICATION_CREDENTIALS telah diatur untuk langkah selanjutnya."

      # 6. Jalankan Skrip Python dengan VERIFIKASI
      - name: Run Python Script
        env:
          URL_TARGET_API: ${{ secrets.URL_TARGET_API }}
        run: |
          # VERIFIKASI 2: Cek apakah variabel terlihat DI DALAM langkah ini
          echo "--- MEMULAI LANGKAH 6 ---"
          echo "Mengecek environment variable..."
          echo "GOOGLE_APPLICATION_CREDENTIALS = $GOOGLE_APPLICATION_CREDENTIALS"
          
          # VERIFIKASI 3: Cek apakah file masih ada dan bisa dibaca
          echo "Mengecek file..."
          ls -l $GOOGLE_APPLICATION_CREDENTIALS
          
          echo "--- Menjalankan Skrip Python ---"
          python main.py
